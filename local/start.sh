#!/bin/bash

# ==========================================
# Golo_cube Launcher v2.0 (Robust Edition)
# Role: System Initialization & Process Management
# ==========================================

# 1. –ñ–ï–°–¢–ö–ê–Ø –§–ò–ö–°–ê–¶–ò–Ø –†–ê–ë–û–ß–ï–ô –î–ò–†–ï–ö–¢–û–†–ò–ò
# –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –Ω–∞–π–¥–µ—Ç .py —Ñ–∞–π–ª—ã, –æ—Ç–∫—É–¥–∞ –±—ã –µ–≥–æ –Ω–∏ –∑–∞–ø—É—Å—Ç–∏–ª–∏
cd "$(dirname "$0")" || { echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–ø–∫—É —Å–∫—Ä–∏–ø—Ç–∞"; exit 1; }
echo "üìÇ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# 2. –ü–†–û–í–ï–†–ö–ê –ì–†–ê–§–ò–ß–ï–°–ö–û–ì–û –û–ö–†–£–ñ–ï–ù–ò–Ø (–î–ª—è Tkinter)
# –ï—Å–ª–∏ DISPLAY –Ω–µ –∑–∞–¥–∞–Ω, –ø—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π :0
if [ -z "$DISPLAY" ]; then
    export DISPLAY=:0
    echo "‚ö†Ô∏è DISPLAY –Ω–µ –±—ã–ª –∑–∞–¥–∞–Ω. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω DISPLAY=:0"
fi

# 3. –§–£–ù–ö–¶–ò–Ø –û–ß–ò–°–¢–ö–ò (CLEANUP)
# –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–æ—Ä—Ç—ã –æ—Å–≤–æ–±–æ–¥—è—Ç—Å—è
function cleanup_old_processes {
    echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
    # –£–±–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å—ã, –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ
    pkill -u "$(whoami)" -f "ngrok"
    pkill -u "$(whoami)" -f "media_choose.py"
    pkill -u "$(whoami)" -f "voise_intension_vosk.py"
    sleep 2
}

cleanup_old_processes

# 4. –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô
# –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Python
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫ Python..."
python3 -c "import rapidfuzz, vosk, flask, PIL, pyaudio" 2>/dev/null
if [ $? -ne 0 ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ –≤—Å–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!"
    echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ: pip install rapidfuzz vosk flask pillow pyaudio requests"
    # –ú—ã –Ω–µ –≤—ã—Ö–æ–¥–∏–º, –Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º.
    sleep 3
else
    echo "‚úÖ –í—Å–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–∞–π–¥–µ–Ω—ã."
fi

# 5. –ó–ê–ü–£–°–ö NGROK (–¢–£–ù–ù–ï–õ–¨)
if command -v ngrok &> /dev/null; then
    echo "üöÄ –ó–∞–ø—É—Å–∫ ngrok..."
    nohup ngrok http 5000 > /tmp/ngrok.log 2>&1 &
    
    # –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (–≤–º–µ—Å—Ç–æ sleep 5)
    echo "‚è≥ –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ngrok..."
    for i in {1..10}; do
        if pgrep -x "ngrok" > /dev/null; then
            break
        fi
        sleep 1
    done
    sleep 2 # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
else
    echo "‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: ngrok –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ. –£–¥–∞–ª–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å."
fi

# 6. –ó–ê–ü–£–°–ö –ì–û–õ–û–°–û–í–û–ì–û –ê–°–°–ò–°–¢–ï–ù–¢–ê (VOSK)
echo "üé§ –ó–∞–ø—É—Å–∫ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (Vosk Offline)..."
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –º–æ–¥–µ–ª–∏
if [ ! -d "model" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: –ü–∞–ø–∫–∞ 'model' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ $(pwd)!"
else
    nohup python3 voise_intension_vosk.py > /tmp/voice.log 2>&1 &
fi

# 7. –ó–ê–ü–£–°–ö –ú–ï–î–ò–ê-–ü–õ–ï–ï–†–ê (–ì–õ–ê–í–ù–´–ô –ü–†–û–¶–ï–°–°)
# –ó–∞–ø—É—Å–∫–∞–µ–º –±–µ–∑ nohup, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª–∏, –µ—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤—Ä—É—á–Ω—É—é.
# –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –æ–Ω —É–¥–µ—Ä–∂–∏—Ç —Å–µ—Å—Å–∏—é –∞–∫—Ç–∏–≤–Ω–æ–π.
echo "üé¨ –ó–∞–ø—É—Å–∫ –º–µ–¥–∏–∞-–ø–ª–µ–µ—Ä–∞..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
if [ -f "media_choose.py" ]; then
    python3 media_choose.py
else
    echo "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –§–∞–π–ª media_choose.py –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi